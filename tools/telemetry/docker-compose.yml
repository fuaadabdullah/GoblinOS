version: '3.8'

services:
  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8888:8888"   # Prometheus metrics
    volumes:
      - ./collector-config.yaml:/etc/otelcol-contrib/config.yaml
    command: ["--config", "/etc/otelcol-contrib/config.yaml"]
    depends_on:
      - tempo
      - zipkin

  # Tempo - Jaeger-compatible distributed tracing
  tempo:
    image: grafana/tempo:latest
    ports:
      - "3200:3200"   # Tempo API
      - "4318:4318"   # OTLP gRPC (conflicts with collector, use different port)
    volumes:
      - tempo-data:/tmp/tempo
    command: ["-config.file=/etc/tempo.yaml"]
    configs:
      - source: tempo-config
        target: /etc/tempo.yaml

  # Zipkin - Classic distributed tracing
  zipkin:
    image: openzipkin/zipkin:latest
    ports:
      - "9411:9411"   # Zipkin UI and API

  # Prometheus for metrics
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'

volumes:
  tempo-data:

configs:
  tempo-config:
    content: |
      server:
        http_listen_port: 3200
        grpc_listen_port: 9095

      distributor:
        receivers:
          otlp:
            protocols:
              grpc:
              http:

      ingester:
        trace_idle_period: 10s
        max_block_bytes: 1_000_000
        max_block_duration: 5m

      compactor:
        compaction:
          compacted_block_retention: 1h

      storage:
        trace:
          backend: local
          local:
            path: /tmp/tempo/traces
          pool:
            max_workers: 100
            queue_depth: 10000

      overrides:
        max_bytes_per_trace: 5000000
